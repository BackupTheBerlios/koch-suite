#!<%%PHP%%> <%%PHP_OPTS%%>
<?

  /*
   * $Id: rk2mm.raw,v 1.4 2001/03/03 13:40:07 michael Exp $
   * Michael Lestinsky <michael@zaphod.rhein-neckar.de>, Okt. 2000
   * Translate REZKONV-formated recipes to Mealmaster-formated recipes.
   *
   * See the bundled file "LICENCE" for the licence of this script.
   */

  require "<%%PHP_LIBS%%>/functions.inc";

  /* Open filedescriptors for the STD-channels */
  $stdin  = fopen("php://stdin", "r");
  $stdout = fopen("php://stdout", "w");
  $stderr = fopen("php://stderr", "w");

  /* Create a temporary file, write $stdin to it and close the
   * temporary file. 
   * Why this way instead of using /dev/stdin directly:
   *   fseek doesn't work on /dev/stdin.
   */

  $temp = tempnam("/tmp", "mmimport");

  $temp_fd = fopen($temp, "w");

  while ($line = fgets($stdin, 1024)) {
    fputs ($temp_fd, preg_replace("/\r/", "", $line));
  }
  fclose ($temp_fd);

  /* Reopen the temporary file for reading */

  $fd = fopen($temp, "r");

  /* --- Main --- */

  while ($line = fgets($fd, 1024)) {
    if (eregi("(={10}).*REZKONV.*", $line)) {
      $rezept = parse_recipe($fd, "RK");
    }

    if (isset($rezept)) {
      /* Parse the recipe, but don't write it to the database.
       * Main purpose: parser-testing
       */
      fputs($stdout, mmexport($rezept));
      fputs($stdout, "\n");
      unset ($rezept);
    }
  }

  /* Close open files */

  fclose($fd);
  unlink($temp);

  /* --- End --- */
?>
