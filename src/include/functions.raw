<?
  /* Functions for the "Koch-Suite" by
   * (c) Michael Lestinsky <michael@zaphod.rhein-neckar.de>, January 2001
   * $Id: functions.raw,v 1.20 2001/02/07 18:35:28 michael Exp $
   *
   * See ../LICENSE for the license of this code.
   */

  require "<%%PHP_LIBS%%>/config.inc";
  require "<%%PHP_LIBS%%>/output.inc";
  /* --- Functions --- */


  function delete_menue ($mid) {
    /* delete a recipe from the database */
    $req = "select * from REZEPT where MENUE_ID = " . $mid;
    $result = mysql_db_query ($GLOBALS["DB_NAME"], $req);

    while ($r = mysql_fetch_array($result)) {
      $req_z = "delete from ZUTATEN where REZEPT_ID = " . $r["ID"];
      $result_z = mysql_db_query ($GLOBALS["DB_NAME"], $req_z);
    }

    $req = "delete from REZEPT where MENUE_ID = " . $mid;
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    $req = "delete from ANWEISUNG where MENUE_ID = " . $mid;
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    $req = "delete from KAT where MENUE_ID = " . $mid;
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    $req = "delete from MENUE where ID = " . $mid;
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);
  }


  function is_unit ($str) {
    // Test, whether a given string is a valid MM-Unit or not

    $req = "select ABBREV from EINHEITEN " .
           " where STRCMP(ABBREV, '$str') = 0 " .
           "    or RK_ABBREV = '$str' ".
           "   and MMUSE     = 'J'";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);
    if (mysql_num_rows($result) == 1) {
      $return = mysql_fetch_array($result);
      return $return[0];
    } else {
      return false;
    }
    mysql_free_result($result);
  }


  function parse_mmrecipe($fd) {
    /* scan a recipe until it's end
     * $fd: read from this filedescriptor
     * return a rather complex 4-dimensional array, 
     * read the source to understand it's format
     */
    $bar            = 0;
    $zutaten        = array();
    $instruction    = "";
    $zutaten_header = "/^(-{5}|M{5})-*(.*)[-=@]*$/i";
    $rezept_ende    = "/^(-{5}|M{5})[@-]*$/";
    $br_lock        = 1;

    while ($line = fgets($fd, 1024)) {
      if (preg_match($rezept_ende, $line)) {
        /* Found the end of the recipe */
        break;
      } else {

        if ($seen_title != 1 and ereg("Title: (.*)", $line, $foo)) {
          $title = trim($foo[1]);
          $seen_title = 1;

        } else if ($seen_categories != 1 and 
                   ereg("Categories: (.*)", $line, $foo)) {

          $categories = split(", *", $foo[1]);
          $seen_categories = 1;
          while(isset($categories[$bar])) {
            $categories[$bar] = trim($categories[$bar]);
            $bar++;
          }

        } else if ($seen_yield != 1 and 
                   ereg("(Servings|Yield): (.*)", $line, $foo)) {

          $yield = trim($foo[2]);
          $seen_yield = 1;

        } else if (preg_match("/^ *$/", $line) and $seen_ingr == 0) {
          # Skip this line

        } else if (preg_match($zutaten_header, $line, $foo)) {
          preg_match("/^(.*)[-@=]*$/U", $foo[2], $bar);
          $j = array("title"       => $bar[1], 
                     "ingredients" => getingr($fd));
          array_push ($zutaten, $j);
          $seen_ingr = 1;

        } else if ($seen_title == 1 and 
                   $seen_categories == 1 and 
                   $seen_yield == 1 and
                   $seen_ingr == 0 ) {
          /* lets look for the ingredients */ 
          $len = strlen($line);
          fseek($fd, -$len, SEEK_CUR);
          $j = array("title" => "Zutaten:", "ingredients" => getingr($fd));
          array_push ($zutaten, $j);
          $seen_ingr = 1;

        } else {
          /* Ok, treat the rest as "instruction"
           */
          $trimmed = trim($line);
          $seen_instructions = 1;
          if ( $trimmed == "" ) {
            if ( $br_lock == 0 ) {
              $instruction .= "<p> ";
            }
            $br_lock = 1;
          } else {
            if ( preg_match("/^:.*$/", $trimmed) and $br_lock == 0 ) {
              $instruction .= "<br> $trimmed ";
            } else 
              $instruction .= "$trimmed ";
            $br_lock = 0;
          }
        }
      }
    }

    /* Strip leading and trailing <p>- and <br>-tags */
    $search = array("/^(<(p|br)>\s*)*/", "/\s*(<(p|br)>\s*)*$/");
    $replace = array("", "");
    $instruction =  preg_replace($search, $replace, $instruction);

    return array("title"     => $title,
                 "category"  => $categories,
                 "yield"     => $yield,
                 "zutaten"   => $zutaten,
                 "anleitung" => $instruction);
  }


  function parse_rkrecipe ($fh) {
    /* Parse Rezepte im REZKONV-Format */

    $zutaten = array();

    $rk_zutatenheader = "/^={6,}.*=*$/";
    $rk_ende = "/^={5}$/";

    while ($line = fgets($fh, 1024)) {
      if (preg_match($rk_ende, $line)) {
        // Ende. Breche aus der while-Schleife aus.
        break;
      } else {
        if ($seen_title == 0 and
            preg_match("/Titel: (.*)$/", $line, $match)) {
          // Titel:

          $title = trim($match[1]);
          $seen_title = 1;

        } else if ($seen_kat == 0 and
            preg_match("/Kategorien: (.*)$/", $line, $match)) {
          // Kategorie:

          $category = split(", *", trim($match[1]));
          $seen_kat = 1;

        } else if ($seen_yield == 0 and 
            preg_match("/^\s*Menge: (.*)$/", $line, $match)) {
          // Menge:
          $yield = trim($match[1]);
          $seen_yield = 1;

        } else if (preg_match("/^\s*$/", $line) and $seen_ingr == 0) {
          # Skip this line

        } else if (preg_match($rk_zutatenheader, $line, $match)) {
          // Rezept-Liste:

          $search  = array("/^={5,}/", "/={5,}$/");
          $replace = array("", "");
          array_push ( $zutaten, 
             array("title"       => preg_replace($search, $replace, $match[0]),
                   "ingredients" => get_rk_ingr($fh)));
          $seen_ingr = 1;
        } else if ($seen_title == 1 and 
                   $seen_kat   == 1 and 
                   $seen_yield == 1 and 
                   $seen_instr == 0 and
                   $seen_ingr  == 0) {

          $len = strlen($line);
          fseek($fh, -$len, SEEK_CUR);
          array_push($zutaten,
                     array("title"       => "Zutaten:",
                           "ingredients" => get_rk_ingr($fh)));
          $seen_ingr = 1;

        } else {
          // Anweisungen:

          $seen_instr = 1;
          $line = trim($line);
          $seen_instr = 1;

          // Ersetze Zeilenumbrueche durch <p> und <br>.
          if ( $line == "" ) {
            if ( $br_lock == 0 ) {
              $instruction .= "<p> ";
            }
            $br_lock = 1;
          } else {
            if ( preg_match("/^:.*$/", $line) and $br_lock == 0 ) {
              $instruction .= "<br> $line ";
            } else 
              $instruction .= "$line ";
            $br_lock = 0;
          }
        } 
      }
    }

    // Entferne <p> und <br> am Anfang und Ende
    $search = array("/^(<(p|br)>\s*)*/", "/\s*(<(p|br)>\s*)*$/");
    $replace = array("", "");
    $instruction = preg_replace($search, $replace, $instruction);

    return array("title"     => $title,
                 "category"  => $category,
                 "yield"     => $yield,
                 "zutaten"   => $zutaten,
                 "anleitung" => $instruction);

  }


  function parse_ingredient($line) {
    /* parse each line */
    if (ereg("([ 0-9\.\/]{7}) (..) (.*)", $line, $foo)) {
      $quant = preg_replace("/\s+/", "+", trim($foo[1]));
      if ($quant != '') {
        $quant = eval("return $quant;");
      } 

      # if (is_unit($foo[2])) {
        return array("quant"  => $quant, 
                     "unit"   => trim($foo[2]), 
                     "ingred" => trim($foo[3]));
      # } else return 0;
    } else return 0;
  }

  function parse_rk_ingredient($line) {
    if (ereg("([ 0-9\.\/]{7}) (.{8}) (.*)", $line, $foo)) {
      $quant = preg_replace("/\s+/", "+", trim($foo[1]));
      if ($quant != '') {
        $quant = eval("return $quant;");
      }

      $rawunit = trim($foo[2]);
      $text = trim($foo[3]);

      $req = "select ABBREV from EINHEITEN where RK_ABBREV = '$rawunit'";
      $res = mysql_db_query($GLOBALS["DB_NAME"], $req);

      if ($res != 0 and $mmunit = mysql_fetch_row($res)) {
        $unit = $mmunit[0];
      } else {
        $unit = '';
        $text = $foo[2] . " " . $text;
      }
      return array("quant"  => $quant, // trim($foo[1]),
                   "unit"   => $unit,
                   "ingred" => $text);
    } else return 0;
  }

  function getingr ($fd) {
    /* read the ingredients 
     * return a 2-dim Array $a[count][ingr-spec]
     * where count is a plain integer-counter, specifying more or less
     * the linenumber of the ingredient and ingr-spec is one of "quant",
     * "unit" or "ingred".
     */
    $a = array();

    while ($line = fgets($fd, 1024)) {
      $len = strlen($line);
      #if (preg_match("/^\s*$/", $line))
      #  break;
      if (($b = parse_ingredient($line)) != 0) {
        array_push ($a, $b);
      } else {
        fseek($fd, -$len, SEEK_CUR);
        break;
      }
    }
    return $a;
  }


  function get_rk_ingr ($fd) {
    /* same as getingr(), except it's for RK-Recipes. */

    $a = array();

    while ($line = fgets($fd, 1024)) {
      $len = strlen($line);
      if (($b = parse_rk_ingredient($line)) != 0) {
        array_push($a, $b);
      } else {
        fseek($fd, -$len, SEEK_CUR);
        break;
      }
    }
    return $a;
  }


  function write_db ($rezept) {
    /* Write a recipe into the database. For the layout of the database
     * see Documentation/init_db.sql
     */

    global $DB_NAME;

    $req = "insert into MENUE values ( " .
          "  0, " .
          "  '" . addslashes($rezept["yield"]) . "', " .
          "  '" . addslashes($rezept["title"]) . "' " .
          "  ) ";
    $result = mysql_db_query($DB_NAME, $req);
    $mid = mysql_insert_id();

    foreach ($rezept["zutaten"] as $z) {
      $req = "insert into REZEPT values ( " .
             "  0, " .
             "  '$mid', " .
             "  '" . addslashes($z["title"]) . "' " .
             " ) ";
      $result = mysql_db_query($DB_NAME, $req);
      $rid = mysql_insert_id();

      foreach ($z["ingredients"] as $i) {
        $req = "insert into ZUTATEN values ( " .
               "  0, " .
               "  '" . addslashes($i["quant"]) . "', " .
               "  '" . addslashes($i["unit"])  . "', " .
               "  '" . addslashes($i["ingred"]) ."', " .
               "  '$rid' ".
               " ) ";
        $result = mysql_db_query($DB_NAME, $req);
      }
    }
    $req = "insert into ANWEISUNG values ( " .
           "  0, " .
           "  '" . addslashes($rezept["anleitung"]) . "', " .
           "  '$mid' " .
           " ) ";
    $result = mysql_db_query($DB_NAME, $req);

    foreach ($rezept["category"] as $cat) {
      $req = "select * from KATEGORIE where TEXT = '$cat'";
      $result = mysql_db_query($DB_NAME, $req);
      if ($r = mysql_fetch_array($result)) {
        $cid = $r["ID"];
      } else {
        $req = "insert into KATEGORIE values ( " .
               "  0, " .
               "  '" . addslashes($cat) . "' " .
               " ) ";
        $result = mysql_db_query($DB_NAME, $req);
        $cid = mysql_insert_id();
      }

      $req = "insert into KAT values ( " .
             "  0, " . 
             "  '$cid', " .
             "  '$mid'  " .
             " ) ";
      $result = mysql_db_query($DB_NAME, $req);
    }
  }


  function get_menu_by_mid ($mid) {
    /* Contruct the menu-array */

    $req = "select * from MENUE where ID = '$mid'";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    $r = mysql_fetch_array($result);

    return array("title" => stripslashes($r["TITEL"]),
                 "yield" => stripslashes($r["PORTIONEN"]),
                 "category" => get_category_by_mid($mid),
                 "zutaten" => get_recipe_by_mid($mid),
                 "anleitung" => get_instructions_by_mid($mid));
  }


  function get_recipe_by_mid ($mid) {
    /* */
    $a = array();

    $req = "select * from REZEPT where MENUE_ID = '$mid' order by ID asc";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    while ($r = mysql_fetch_array($result)) {
      array_push($a, array("title" => stripslashes($r["TITEL"]),
                                "ingredients" => get_ingr_by_rid($r["ID"])));
    }
    return $a;
  }


  function get_ingr_by_rid ($rid) {
    /* return an array with all the ingredients, belonging to an "Rezept" */
    $a = array();

    $req = "select * from ZUTATEN where REZEPT_ID = '$rid' order by ID asc";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    while($r = mysql_fetch_array($result)) {
      array_push($a, array("quant" => stripslashes($r["MENGE"]),
                                "unit"  => stripslashes($r["EINHEIT"]),
                                "ingred" => stripslashes($r["TEXT"])));
    }
    return $a;
  }


  function get_category_by_mid ($mid) {
    $a = array();

    $req = "select * from KAT where MENUE_ID = '$mid'";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    while ($r = mysql_fetch_array($result)) {
      $req_1 = "select * from KATEGORIE where ID = " . $r["KATEGORIE_ID"];
      $res_1 = mysql_db_query($GLOBALS["DB_NAME"], $req_1);

      $f = mysql_fetch_array($res_1);

      array_push($a, stripslashes($f["TEXT"]));
    }
    return $a;
  }


  function get_instructions_by_mid($mid) {
    $req = "select * from ANWEISUNG where MENUE_ID = '$mid'";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    $f = mysql_fetch_array($result);

    return stripslashes($f["TEXT"]);
  }


  function get_categories() {
    /* returns an array containing all available categories */
    $a = array();
    $req = "select * from KATEGORIE order by TEXT" ;
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    while ($c = mysql_fetch_array($result)) {
      array_push($a, stripslashes($c["TEXT"]));
    }

    return $a;
  }


  function get_mid_by_name($name) {
    /* Search the database for $name in the menu-title */
    global $DB_NAME;
    $a = array();

    $req = "select * from MENUE where TITEL like '$name' order by TITEL asc";
    $result = mysql_db_query($DB_NAME, $req);

    while ($r = @mysql_fetch_array($result)) {
      array_push($a, array("id"    => stripslashes($r["ID"]),
                           "title" => stripslashes($r["TITEL"])));
    }

    return $a;
  }


  function get_mid_by_ingred($ingred) {
    /* Search the database for a menu containing a special ingredient
     * "ingred". 
     * Returns "0" if noone found, an array of an associative arrays
     * ("ID", "PORTIONEN", "TITEL") otherwise.
     */
    $m = array();

    $req = "select * from ZUTATEN where TEXT like '%". addslashes($ingred) . "%'";
    $result = mysql_db_query($GLOBALS["DB_NAME"], $req);

    while ($z = mysql_fetch_array($result)) {
      $req = "select * from REZEPT where ID = '" .
             addslashes($z["REZEPT_ID"]) . "'";

      $result_rid = mysql_db_query($GLOBALS["DB_NAME"], $req);

      if ($r = @mysql_fetch_array($result_rid)) {
        $req_mid = "select * from MENUE where ID = '" . $r["MENUE_ID"] . "'"; 
        $result_mid = mysql_db_query($GLOBALS["DB_NAME"], $req_mid);
       
        $j = mysql_fetch_array($result_mid); 
        array_push ($m, array("id" => $j["ID"], "title" => $j["TITEL"]));
      }
    }

    if (count($m) > 0) {
      return array_unique($m);
    } else {
      return 0;
    }
  }

  function get_mid_by_cat ($cat) {
    /* get all menus with category $cat */
    $a = array();

    /* request the ID of the category */
    $req = "select distinct ID from KATEGORIE where TEXT = '$cat'";
    $res = mysql_db_query($GLOBALS["DB_NAME"], $req);
    $id  = mysql_fetch_array($res);
  
    /* which menues are of the category $id["ID"]? */ 
    $req_mid = "select distinct MENUE_ID from KAT " .
               " where KATEGORIE_ID = " . $id["ID"] ;
    if ($res_mid = mysql_db_query($GLOBALS["DB_NAME"], $req_mid)) {
      while ($mid = mysql_fetch_row($res_mid)) {
        /* for each entry: request the id and title and push them into
         * the result-array */
        $req_menu = "select * from MENUE where ID = " . $mid[0];
        $res_menu = mysql_db_query($GLOBALS["DB_NAME"], $req_menu);
  
        if ($menu = mysql_fetch_array($res_menu)) {
          array_push($a, array("id"    => stripslashes($menu["ID"]), 
                               "title" => stripslashes($menu["TITEL"]) ));
        }
      }
      return $a;
    } else {
      return false;
    }
  }

?>
