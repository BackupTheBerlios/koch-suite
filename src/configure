#!/bin/sh
# $Id: configure,v 1.17 2001/10/15 07:28:57 lestinsky Exp $
#
# Copyright (c) 2001
#      Michael Lestinsky. All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#      This product includes software developed by Michael Lestinsky.
#
# THIS SOFTWARE IS PROVIDED BY MICHAEL LESTINSKY ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL MICHAEL LESTINSKY BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
# Parse the config-File and create a sed-Script from it.

CONF_RAW=config
CONF_RAW_MY=config.my
CONF_FILE=config.sed
AWKSCRIPT=genconfig.awk

if [ -f ${CONF_RAW_MY} ] ; then 
  CONF_RAW=${CONF_RAW_MY}
fi

THISDIR=$(pwd)

check_prereq () {
    # Check if we can find all neccessary tools:
    echo -n "Checking for '$1': ... "
    req=$(which "$1")
    if [ -n "${req}" -a $? = 0 ] ; then 
        # Found.
        echo "Found - $req"
    else
        echo "Not Found!"
        exit 2
    fi
}

check_opt () {
    # Check for optional tools an add their path to the config.sed
    echo -n "Checking for '$1': ... "
    req=$(which "$1")
    if [ -n "${req}" -a $? = 0 ] ; then
        # Found.
        echo "Found - $req"
        echo "s:<%%$1%%>:${req}:" >> ${CONF_FILE}
    else 
        echo "Not Found!"
        echo "s:<%%$1%%>:none:" >> ${CONF_FILE}
    fi
}

make_makefiles () {
    # Generate Makefiles in Directory $1
    ( 
        echo -n "Generating Makefile in ./$1 ... ";
        cd "$1";
        translate_raw Makefile
        echo "Done."
    )
}

translate_raw () {
    # Translate Raw files
    sed -f ${THISDIR}/${CONF_FILE} $1.raw > $1
}

##########
# Build-Depends: 'awk' and 'sed'
echo -n "Checking for a usable awk ... "
for i in mawk nawk gawk awk; do
  awk=$(which $i)
  if [ -n "${awk}" -a $? = 0 ] ; then
    break;
  fi
done
if [ -z "${awk}" ] ; then
  echo "Not Found"
  exit 1
else
  echo "Found - ${awk}"
fi

check_prereq sed

##########
# Generate the sed-file:
echo -n "Generating config.sed ... "
${awk} -f ${AWKSCRIPT} ${CONF_RAW} > ${CONF_FILE}
if [ $? = 0 ] ; then 
  echo "Done."
else 
  echo "Failed."
  exit $?
fi

##########
# Optional tools:
TOOLS="latex dvips gs"
for foo in ${TOOLS} ; do
  check_opt ${foo}
done

##########
# Create the Makefiles:
SUBDIRS="include www www/pics commands man"
for foo in ${SUBDIRS}
do
    make_makefiles "${foo}"
done

exit 0
