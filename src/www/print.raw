<?php
  /* $Id: print.raw,v 1.14 2001/12/31 11:53:22 lestinsky Exp $
   *
   * stripped down html-version of recipe.
   * (c) 2001 Michael Lestinsky <michael@zaphod.rhein-neckar.de>
   *
   * Copyright (c) 2001
   *      Michael Lestinsky. All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
   *    notice, this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright
   *    notice, this list of conditions and the following disclaimer in the
   *    documentation and/or other materials provided with the distribution.
   * 3. All advertising materials mentioning features or use of this software
   *    must display the following acknowledgement:
   *      This product includes software developed by Michael Lestinsky.
   *
   * THIS SOFTWARE IS PROVIDED BY MICHAEL LESTINSKY ``AS IS'' AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED.  IN NO EVENT SHALL MICHAEL LESTINSKY BE LIABLE
   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
   * SUCH DAMAGE.
   */

  include "<%%ETC_PREFIX%%>/koch-suite.inc";
  include "<%%PHP_LIBS%%>/lang.inc";
  include "<%%PHP_LIBS%%>/functions.inc";
  include "<%%PHP_LIBS%%>/auth.inc";

  auth(READ);


  function latex_file ($text) {
    $filename = tempnam($GLOBALS["TMPDIR"], "KOCHSUITE");
    $fp = fopen("$filename.ltx", "w");
    fputs($fp, latex_header());
    fputs($fp, $text);
    fputs($fp, latex_footer());
    fclose($fp);
    return $filename;
  }


  function error_message () {
    ?>
    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
        "http://www.w3.org/TR/REC-html40/loose.dtd">
    <html>

    <head>
      <link rel="stylesheet" type="text/css" href="styles.css" />
      <link rev="made" href="mailto:michael@zaphod.rhein-neckar.de" />
      <meta http-equiv="Content-Style-Type" content="text/css">

      <title>Koch-Suite</title>
      <!-- $Id: print.raw,v 1.14 2001/12/31 11:53:22 lestinsky Exp $ -->
    </head>
    <body>
    <h1>Error</h1>
    <p>
      An runtime-error occured. Please consult your logfile for details.
    </p>
    </body>
    </html>
    <?
  }


  chdir ("/tmp");
  umask (0022);

  $mid     = $HTTP_GET_VARS["mid"];

  $format = printable_format($PRINTABLE_FORMAT);

  switch ($format) {
    case "html":
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>

<head>
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <link rev="made" href="mailto:michael@zaphod.rhein-neckar.de" />
  <meta http-equiv="Content-Style-Type" content="text/css">

  <title>Koch-Suite</title>
  <!-- $Id: print.raw,v 1.14 2001/12/31 11:53:22 lestinsky Exp $ -->
</head>

<body>
<?php
  echo format_recipe_html(get_menu_by_mid($mid));
?>
</body>
</html>

<?
      break;
    case "latex":
      $recipe=latex_export(get_menu_by_mid($mid));
      $filename = latex_file($recipe);

      exec("$LATEX $filename.ltx > /dev/null 2>&1");

      if (file_exists("$filename.dvi")) {
        header("Content-Type: " . MIMETYPE_DVI);
        header("Content-Disposition: inline; filename=\"".$filename.".dvi\"");
        readfile ($filename . ".dvi");
      } else error_message();

      break;
    case "ps":
      $recipe=latex_export(get_menu_by_mid($mid));
      $filename = latex_file($recipe);
      exec("$LATEX $filename.ltx  > /dev/null 2>&1");
      exec("$DVIPS -o $filename.ps $filename.dvi > /dev/null 2>&1");

      if (file_exists("$filename.ps")) {
        header("Content-Type: " . MIMETYPE_PS);
        header("Content-Disposition: inline; filename=\"".$filename.".pdf\"");
        readfile ($filename . ".ps");
      } else error_messate();

      break;
    case "pdf":
      $recipe=latex_export(get_menu_by_mid($mid));
      $filename = latex_file($recipe);

      if (!empty($PDFLATEX)) {
        exec("$PDFLATEX $filename.ltx > /dev/null 2>&1");
      } else {
        exec("$LATEX $filename.ltx > /dev/null 2>&1");
        exec("$DVIPS -o $filename.ps $filename.dvi > /dev/null 2>&1");
        exec("$GS -q -dBATCH -dNOPAUSE -sDEVICE=pdfwrite -sOutputFile=$filename.pdf $filename.ps > /dev/null 2>&1");
      }
      if (file_exists("$filename.pdf")) {
        header("Content-Type: " . MIMETYPE_PDF);
        header("Content-Disposition: inline; filename=\"".$filename.".pdf\"");
        readfile ($filename . ".pdf");
      } else error_message();

      break;
    default:
      die ("Configuration-Error: Unsupported format.\n");
  }

  db_disconnect();
?>
